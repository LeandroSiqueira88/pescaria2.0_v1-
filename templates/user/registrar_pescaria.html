{% extends "base.html" %}

{% block title %}Registrar Nova Pescaria{% endblock %}

{% block content %}
    <div class="card">
        <h2>Registrar Nova Pescaria</h2>
        
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

        <form method="POST" action="{{ url_for('user.registrar_pescaria') }}" enctype="multipart/form-data">
            
            <label for="id_peixe">Espécie do Peixe:</label>
            <select id="id_peixe" name="id_peixe" required>
                <option value="">Selecione a Espécie</option>
                {% for peixe in peixes %}
                    <option value="{{ peixe.id_peixe }}">{{ peixe.nome_comum }}</option>
                {% endfor %}
            </select>
            
            <label for="peso">Peso (kg):</label>
            <input type="number" step="0.01" id="peso" name="peso">
            
            <label for="comprimento">Comprimento (cm):</label>
            <input type="number" step="0.01" id="comprimento" name="comprimento">

            <label for="data">Data e Hora:</label>
            <input type="datetime-local" id="data" name="data" required>
            
            <label for="descricao">Descrição da Pesca (Opcional):</label>
            <textarea id="descricao" name="descricao" rows="4"></textarea> 
                        
            <label for="foto">Foto da Pescaria:</label>
            <input type="file" id="foto" name="foto" accept="image/*" required>
            
            <label for="localizacao">Localização da Pescaria (Clique no mapa para marcar):</label>
            <div id="map" style="height: 600px; width: 100%; max-width: 1200px; margin: 0 auto; border-radius: var(--border-radius); margin-bottom: 1rem;"></div>
            
            <input type="text" id="local" name="local" placeholder="Localização atual: Lat, Lon" required>

            <input type="hidden" id="latitude" name="latitude">
            <input type="hidden" id="longitude" name="longitude">

            <button type="submit">Registrar Pescaria</button>
        </form>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Inicialização do mapa
        var map = L.map('map').setView([-15.7801, -47.9292], 4); // Coordenada central (Brasília) e zoom

        // Adicionando a camada de tiles (mapa base)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        var marker = null; 

        // Função para atualizar a localização em TODOS os campos
        function updateLocation(lat, lng) {
            // ATUALIZA O CAMPO DE TEXTO VISÍVEL (name="local")
            document.getElementById('local').value = `Lat: ${lat.toFixed(6)}, Lon: ${lng.toFixed(6)}`;
            
            // ATUALIZA OS CAMPOS OCULTOS
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;

            // Remove o marcador anterior, se existir
            if (marker) {
                map.removeLayer(marker);
            }

            // Adiciona um novo marcador
            marker = L.marker([lat, lng]).addTo(map)
                .bindPopup("Local da Pescaria").openPopup();
        }

        // Evento de clique no mapa
        map.on('click', function(e) {
            updateLocation(e.latlng.lat, e.latlng.lng);
        });

        // Tente obter a localização atual do usuário
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var initialLat = position.coords.latitude;
                var initialLng = position.coords.longitude;
                
                map.setView([initialLat, initialLng], 12); // Centraliza no usuário
                updateLocation(initialLat, initialLng); // Define a localização inicial
            });
        }
    </script>    
{% endblock %}